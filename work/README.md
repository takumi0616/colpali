# ColPali Work - ç”»åƒã‹ã‚‰ãƒãƒ«ãƒãƒ™ã‚¯ãƒˆãƒ«æŠ½å‡º

## ğŸ“– æ¦‚è¦

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€ColPali ã‚’ä½¿ã£ã¦**ç”»åƒã‹ã‚‰ãƒãƒ«ãƒãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ128 æ¬¡å…ƒ Ã—N ãƒˆãƒ¼ã‚¯ãƒ³ ã¾ãŸã¯ 2,048 æ¬¡å…ƒ Ã—N ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã‚’å–å¾—ã™ã‚‹**ãŸã‚ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

**transformers ã®å…¬å¼ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£…** (`ColPaliForRetrieval`) ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã‚·ãƒ³ãƒ—ãƒ«ã§å®‰å®šã—ãŸå‹•ä½œã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

---

## âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. ç’°å¢ƒæ§‹ç¯‰

```bash
# condaç’°å¢ƒã‚’ä½œæˆ
conda env create -f colpali_env.yml

# ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–
conda activate colpali_env

# HuggingFaceã«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåˆå›ã®ã¿ï¼‰
# â€» PaliGemma ãƒ¢ãƒ‡ãƒ«ã¯åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™
huggingface-cli login
```

### 2. å®Ÿè¡Œä¾‹

```bash
# 128æ¬¡å…ƒåŸ‹ã‚è¾¼ã¿ã‚’å–å¾—ï¼ˆæ¤œç´¢ç”¨ï¼‰
python main.py --image ./image/image-1720337388465.jpeg --embedding-type 128dim

# 2,048æ¬¡å…ƒåŸ‹ã‚è¾¼ã¿ã‚’å–å¾— + Mean Poolingï¼ˆOCRå“è³ªäºˆæ¸¬ç”¨ãƒ»æ¨å¥¨ï¼‰
python main.py --image ./image/image-1720337388465.jpeg --embedding-type 2048dim --pooling mean

# Concat Poolingï¼ˆ3ã¤ã®çµ±è¨ˆé‡ã‚’é€£çµï¼‰
python main.py --image ./image/image-1720337388465.jpeg --embedding-type 2048dim --pooling concat
```

---

## ğŸ—ºï¸ å…¨ä½“ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         main.pyï¼ˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰                      â”‚
â”‚          transformers.ColPaliForRetrieval ã‚’ä½¿ç”¨                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ColPaliFor      â”‚           â”‚ ColPaliProcessor â”‚
         â”‚  Retrieval       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (å‰å‡¦ç†)        â”‚
         â”‚  (transformers)  â”‚           â”‚  (transformers)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â”‚               â”‚
    â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Vision   â”‚  â”‚ç·šå½¢å°„å½±â‘  â”‚  â”‚ç·šå½¢å°„å½±â‘¡    â”‚
â”‚Encoder  â”‚â†’ â”‚1152â†’2048 â”‚â†’ â”‚2048â†’128     â”‚
â”‚(SigLIP) â”‚  â”‚          â”‚  â”‚(embedding_  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ proj_layer) â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚
                    â–¼               â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚2048æ¬¡å…ƒ       â”‚  â”‚128æ¬¡å…ƒ    â”‚
            â”‚Ã—1,030ãƒˆãƒ¼ã‚¯ãƒ³ â”‚  â”‚Ã—1,030    â”‚
            â”‚(Gemmaã®ä¸–ç•Œ)  â”‚  â”‚ãƒˆãƒ¼ã‚¯ãƒ³   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Pooling     â”‚
                    â”‚ (Mean/Max/   â”‚
                    â”‚  Std/Concat) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  å›ºå®šé•·      â”‚
                    â”‚  ãƒ™ã‚¯ãƒˆãƒ«    â”‚
                    â”‚ (2048/128/   â”‚
                    â”‚  6144/384)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ LightGBM/SVR â”‚
                    â”‚ (OCRå“è³ªäºˆæ¸¬)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ç›®çš„

1. **ç”»åƒ â†’ ColPali â†’ ãƒãƒ«ãƒãƒ™ã‚¯ãƒˆãƒ«å–å¾—**

   - 128 æ¬¡å…ƒ Ã— 1,030 ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæ¤œç´¢ç”¨ã«æœ€é©åŒ–ï¼‰
   - 2,048 æ¬¡å…ƒ Ã— 1,030 ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆGemma ã®ç”Ÿã®è¡¨ç¾ï¼‰

2. **Pooling é©ç”¨ã§å›ºå®šé•·ãƒ™ã‚¯ãƒˆãƒ«åŒ–**

   - Mean Pooling / Max Pooling / Std Pooling
   - Concatï¼ˆMean + Max + Std ã‚’é€£çµï¼‰

3. **OCR å“è³ªäºˆæ¸¬ã¸ã®å¿œç”¨**
   - å›ºå®šé•·ãƒ™ã‚¯ãƒˆãƒ« â†’ LightGBM/SVR â†’ OCR ç²¾åº¦äºˆæ¸¬

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
colpali/work/
â”œâ”€â”€ README.md                    # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä»•æ§˜æ›¸ï¼‰
â”œâ”€â”€ main.py                      # ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ â˜…
â”œâ”€â”€ colpali_env.yml              # condaç’°å¢ƒå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ modeling_colpali.py          # ã‚«ã‚¹ã‚¿ãƒ ColPaliãƒ¢ãƒ‡ãƒ«å®šç¾©ï¼ˆå‚è€ƒç”¨ãƒ»æœªä½¿ç”¨ï¼‰
â”œâ”€â”€ modeling_colqwen2.py         # ColQwen2ãƒ¢ãƒ‡ãƒ«å®šç¾©ï¼ˆå‚è€ƒç”¨ãƒ»æœªä½¿ç”¨ï¼‰
â”œâ”€â”€ processing_colpali.py        # ã‚«ã‚¹ã‚¿ãƒ ColPaliãƒ—ãƒ­ã‚»ãƒƒã‚µï¼ˆå‚è€ƒç”¨ãƒ»æœªä½¿ç”¨ï¼‰
â”œâ”€â”€ processing_colqwen2.py       # ColQwen2ãƒ—ãƒ­ã‚»ãƒƒã‚µï¼ˆå‚è€ƒç”¨ãƒ»æœªä½¿ç”¨ï¼‰
â”œâ”€â”€ processing_utils.py          # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆå‚è€ƒç”¨ï¼‰
â””â”€â”€ image/
    â””â”€â”€ image-1720337388465.jpeg # ã‚µãƒ³ãƒ—ãƒ«ç”»åƒ
```

> **æ³¨æ„**: ç¾åœ¨ã® `main.py` ã¯ `transformers` ã®ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£… (`ColPaliForRetrieval`, `ColPaliProcessor`) ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚`modeling_colpali.py` ãªã©ã®ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…ã¯å‚è€ƒç”¨ã«æ®‹ã—ã¦ã„ã¾ã™ã€‚

---

## ğŸš€ ä½¿ã„æ–¹

### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°

| å¼•æ•°               | èª¬æ˜                                   | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ               |
| ------------------ | -------------------------------------- | ------------------------ |
| `--image`          | å…¥åŠ›ç”»åƒã®ãƒ‘ã‚¹ï¼ˆ**å¿…é ˆ**ï¼‰             | -                        |
| `--model-name`     | HuggingFace ã®ãƒ¢ãƒ‡ãƒ«å                 | `vidore/colpali-v1.3-hf` |
| `--embedding-type` | `128dim` ã¾ãŸã¯ `2048dim`              | `128dim`                 |
| `--pooling`        | `none`, `mean`, `max`, `std`, `concat` | `none`                   |
| `--device`         | `auto`, `cuda`, `mps`, `cpu`           | `auto`                   |

### å®Ÿè¡Œä¾‹ã¨å‡ºåŠ›

#### ä¾‹ 1: 128 æ¬¡å…ƒãƒãƒ«ãƒãƒ™ã‚¯ãƒˆãƒ«ï¼ˆãƒ—ãƒ¼ãƒªãƒ³ã‚°ãªã—ï¼‰

```bash
python main.py --image ./image/image-1720337388465.jpeg --embedding-type 128dim
```

**å‡ºåŠ›:**

```
ğŸ” HuggingFaceèªè¨¼ã‚’è¨­å®šä¸­...
   âœ… HF_TOKENã‚’.envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ

ğŸ“¸ ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­: ./image/image-1720337388465.jpeg
   ç”»åƒã‚µã‚¤ã‚º: (800, 800)

ğŸ¤– ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­: vidore/colpali-v1.3-hf
   ï¼ˆtransformersãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£… ColPaliForRetrieval ã‚’ä½¿ç”¨ï¼‰
   âœ… ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†

ğŸ”„ 128dim åŸ‹ã‚è¾¼ã¿ã‚’å–å¾—ä¸­...

ğŸ“Š ãƒãƒ«ãƒãƒ™ã‚¯ãƒˆãƒ«æƒ…å ±:
   - ãƒãƒƒãƒã‚µã‚¤ã‚º: 1
   - ãƒˆãƒ¼ã‚¯ãƒ³æ•°: 1030
   - åŸ‹ã‚è¾¼ã¿æ¬¡å…ƒ: 128
   - ãƒ‡ãƒã‚¤ã‚¹: cuda:0
   - shape: (1, 1030, 128)

âœ… å®Œäº†ï¼

ğŸ’¡ ä½¿ç”¨ä¾‹:
   1. Late Interaction (MaxSim) ã§æ¤œç´¢ã«ä½¿ç”¨
   2. Poolingã‚’é©ç”¨ã—ã¦å›ºå®šé•·ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã€æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã«å…¥åŠ›
```

#### ä¾‹ 2: 2048 æ¬¡å…ƒ + Mean Poolingï¼ˆOCR å“è³ªäºˆæ¸¬ç”¨ãƒ»æ¨å¥¨ï¼‰

```bash
python main.py --image ./image/image-1720337388465.jpeg --embedding-type 2048dim --pooling mean
```

**å‡ºåŠ›:**

```
ğŸ“Š ãƒãƒ«ãƒãƒ™ã‚¯ãƒˆãƒ«æƒ…å ±:
   - ãƒãƒƒãƒã‚µã‚¤ã‚º: 1
   - ãƒˆãƒ¼ã‚¯ãƒ³æ•°: 1030
   - åŸ‹ã‚è¾¼ã¿æ¬¡å…ƒ: 2048
   - ãƒ‡ãƒã‚¤ã‚¹: cuda:0
   - shape: (1, 1030, 2048)

ğŸ¯ MEAN ãƒ—ãƒ¼ãƒªãƒ³ã‚°ã‚’é©ç”¨ä¸­...
   å›ºå®šé•·ãƒ™ã‚¯ãƒˆãƒ« shape: (1, 2048)

âœ… å®Œäº†ï¼

ğŸ’¡ ä½¿ç”¨ä¾‹:
   ã“ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’LightGBMã‚„SVRã«å…¥åŠ›ã—ã¦ã€OCRå“è³ªäºˆæ¸¬ãŒå¯èƒ½ã§ã™ã€‚
   ä¾‹: pooled_vector.cpu().float().numpy() â†’ shape: (1, 2048)
```

#### ä¾‹ 3: 2048 æ¬¡å…ƒ + Concat Pooling

```bash
python main.py --image ./image/image-1720337388465.jpeg --embedding-type 2048dim --pooling concat
```

**å‡ºåŠ›:**

```
ğŸ¯ CONCAT ãƒ—ãƒ¼ãƒªãƒ³ã‚°ã‚’é©ç”¨ä¸­...
   å›ºå®šé•·ãƒ™ã‚¯ãƒˆãƒ« shape: (1, 6144)
```

---

## ğŸ“Š å‡ºåŠ›ã®æ„å‘³

### ãƒãƒ«ãƒãƒ™ã‚¯ãƒˆãƒ«æƒ…å ±

| é …ç›®             | èª¬æ˜                                                       |
| ---------------- | ---------------------------------------------------------- |
| **ãƒãƒƒãƒã‚µã‚¤ã‚º** | å‡¦ç†ã—ãŸç”»åƒã®æšæ•°                                         |
| **ãƒˆãƒ¼ã‚¯ãƒ³æ•°**   | ç”»åƒãƒ‘ãƒƒãƒæ•° + ç‰¹åˆ¥ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆColPali ã§ã¯ç´„ 1,030 å›ºå®šï¼‰ |
| **åŸ‹ã‚è¾¼ã¿æ¬¡å…ƒ** | å„ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ™ã‚¯ãƒˆãƒ«æ¬¡å…ƒï¼ˆ128 or 2048ï¼‰                    |
| **ãƒ‡ãƒã‚¤ã‚¹**     | è¨ˆç®—ã«ä½¿ç”¨ã—ãŸãƒ‡ãƒã‚¤ã‚¹ï¼ˆcuda/mps/cpuï¼‰                     |
| **shape**        | ãƒ†ãƒ³ã‚½ãƒ«ã®å½¢çŠ¶ `(ãƒãƒƒãƒ, ãƒˆãƒ¼ã‚¯ãƒ³æ•°, æ¬¡å…ƒ)`                |

### å›ºå®šé•·ãƒ™ã‚¯ãƒˆãƒ« shapeï¼ˆPooling é©ç”¨å¾Œï¼‰

| è¨­å®š               | å‡ºåŠ› shape  | èª¬æ˜                         |
| ------------------ | ----------- | ---------------------------- |
| `128dim + mean`    | `(1, 128)`  | æ¤œç´¢ç”¨ã®è»½é‡ãƒ™ã‚¯ãƒˆãƒ«         |
| `128dim + concat`  | `(1, 384)`  | 128 Ã— 3                      |
| `2048dim + mean`   | `(1, 2048)` | **OCR å“è³ªäºˆæ¸¬ç”¨ãƒ»æ¨å¥¨**     |
| `2048dim + concat` | `(1, 6144)` | 2048 Ã— 3ï¼ˆæœ€ã‚‚æƒ…å ±é‡ãŒå¤šã„ï¼‰ |

---

## ğŸ” æŠ€è¡“è©³ç´°

### 1. ãƒ¢ãƒ‡ãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
ColPaliForRetrieval
â”œâ”€â”€ vlm: PaliGemmaForConditionalGeneration  â† å…ƒã®VLM
â”‚   â”œâ”€â”€ model: PaliGemmaModel
â”‚   â”‚   â”œâ”€â”€ vision_tower: SigLIP (ç”»åƒã‚¨ãƒ³ã‚³ãƒ¼ãƒ€)
â”‚   â”‚   â”œâ”€â”€ multi_modal_projector: Linear(1152â†’2048)
â”‚   â”‚   â””â”€â”€ language_model: Gemma-2B
â”‚   â””â”€â”€ lm_head: Linear
â””â”€â”€ embedding_proj_layer: Linear(2048â†’128)  â† æ¤œç´¢ç”¨å°„å½±
```

### 2. åŸ‹ã‚è¾¼ã¿æ¬¡å…ƒã®é•ã„

#### **128 æ¬¡å…ƒï¼ˆæ¤œç´¢ç”¨ï¼‰**

```python
outputs = model(**batch_images)
embeddings = outputs.embeddings  # (batch, 1030, 128)
```

- **ç”¨é€”**: æ¤œç´¢ï¼ˆRetrievalï¼‰ã«æœ€é©åŒ–
- **ç‰¹å¾´**: ColPali ã®å­¦ç¿’ã§æœ€é©åŒ–æ¸ˆã¿ã€L2 æ­£è¦åŒ–æ¸ˆã¿
- **ãƒ¡ãƒªãƒƒãƒˆ**: è»½é‡ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŠ¹ç‡ãŒè‰¯ã„ï¼ˆç´„ 256KB/ç”»åƒï¼‰
- **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**: ç”»è³ªåŠ£åŒ–æƒ…å ±ãŒå¸Œé‡ˆã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§

#### **2048 æ¬¡å…ƒï¼ˆGemma ã®ä¸–ç•Œï¼‰**

```python
outputs = model.vlm(**batch_images, output_hidden_states=True)
embeddings = outputs.hidden_states[-1]  # (batch, 1030, 2048)
```

- **ç”¨é€”**: ã‚ˆã‚Šè±Šã‹ãªç‰¹å¾´è¡¨ç¾ã€OCR å“è³ªäºˆæ¸¬
- **ç‰¹å¾´**: Gemma-2B ã®ç”Ÿã®å‡ºåŠ›
- **ãƒ¡ãƒªãƒƒãƒˆ**: ç”»è³ªåŠ£åŒ–æƒ…å ±ã‚’ä¿æŒã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
- **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒé‡ã„ï¼ˆç´„ 4MB/ç”»åƒã€128 æ¬¡å…ƒã® 16 å€ï¼‰

### 3. Pooling æ–¹æ³•

| æ–¹æ³•       | ã‚³ãƒ¼ãƒ‰                     | ç”¨é€”                           |
| ---------- | -------------------------- | ------------------------------ |
| **Mean**   | `embeddings.mean(dim=1)`   | å…¨ä½“çš„ãªå‚¾å‘ï¼ˆæ˜ã‚‹ã•ã€ã¼ã‘ï¼‰   |
| **Max**    | `embeddings.max(dim=1)[0]` | æœ€ã‚‚é¡•è‘—ãªç‰¹å¾´ï¼ˆãƒã‚¤ã‚ºã€æ±šã‚Œï¼‰ |
| **Std**    | `embeddings.std(dim=1)`    | æƒ…å ±é‡ã®ãƒ ãƒ©ï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆï¼‰   |
| **Concat** | Mean + Max + Std ã‚’é€£çµ    | å¤šè§’çš„ãªå“è³ªè©•ä¾¡               |

### 4. ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã®æ±ºå®š

```
å…¥åŠ›ç”»åƒ: 448Ã—448 ã«ãƒªã‚µã‚¤ã‚º
ãƒ‘ãƒƒãƒã‚µã‚¤ã‚º: 14Ã—14
ãƒ‘ãƒƒãƒæ•°: 32Ã—32 = 1,024å€‹
ç‰¹åˆ¥ãƒˆãƒ¼ã‚¯ãƒ³: BOSç­‰ã§ç´„6å€‹
åˆè¨ˆ: ç´„1,030ãƒˆãƒ¼ã‚¯ãƒ³
```

---

## ğŸ’¡ HuggingFace èªè¨¼ã«ã¤ã„ã¦

### æ–¹æ³• 1: .env ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ¨å¥¨ï¼‰

`colpali/.env` ãƒ•ã‚¡ã‚¤ãƒ«ã« `HF_TOKEN` ã‚’è¨­å®šã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ï¼š

```
HF_TOKEN=hf_xxxxxxxxxxxxxxxxxxxxx
```

### æ–¹æ³• 2: ç’°å¢ƒå¤‰æ•°

```bash
export HF_TOKEN=hf_xxxxxxxxxxxxxxxxxxxxx
```

### æ–¹æ³• 3: CLI ãƒ­ã‚°ã‚¤ãƒ³

```bash
huggingface-cli login
```

> **é‡è¦**: PaliGemma ãƒ¢ãƒ‡ãƒ«ã¯åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™ã€‚åˆã‚ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€[google/paligemma-3b-mix-448](https://huggingface.co/google/paligemma-3b-mix-448) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡

- **ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚º**: ç´„ 5GBï¼ˆBFloat16ï¼‰
- **128 æ¬¡å…ƒ**: ç´„ 256KB/ç”»åƒ
- **2048 æ¬¡å…ƒ**: ç´„ 4MB/ç”»åƒ

### 2. GPU æ¨å¥¨

- ColPali ã¯ç´„ 3B ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤§è¦æ¨¡ãƒ¢ãƒ‡ãƒ«
- CPU å®Ÿè¡Œã¯å¯èƒ½ã ãŒéå¸¸ã«é…ã„ï¼ˆæ•°åˆ†/ç”»åƒï¼‰
- NVIDIA GPUï¼ˆCUDAï¼‰ã¾ãŸã¯ Apple Siliconï¼ˆMPSï¼‰ã‚’æ¨å¥¨

### 3. BFloat16 ã«ã¤ã„ã¦

ãƒ¢ãƒ‡ãƒ«ã¯ `torch.bfloat16` ã§å‹•ä½œã—ã¾ã™ã€‚NumPy ã¯ BFloat16 ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã€NumPy é…åˆ—ã«å¤‰æ›ã™ã‚‹éš›ã¯ `float32` ã«å¤‰æ›ã—ã¦ãã ã•ã„ï¼š

```python
numpy_array = pooled.cpu().float().numpy()
```

---

## ğŸ”§ Python ã‹ã‚‰ã®ä½¿ç”¨æ–¹æ³•

```python
import torch
from PIL import Image
from transformers import ColPaliForRetrieval, ColPaliProcessor

# ãƒ¢ãƒ‡ãƒ«ã¨ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’ãƒ­ãƒ¼ãƒ‰
model = ColPaliForRetrieval.from_pretrained(
    "vidore/colpali-v1.3-hf",
    torch_dtype=torch.bfloat16,
    device_map="auto",
).eval()

processor = ColPaliProcessor.from_pretrained("vidore/colpali-v1.3-hf")

# ç”»åƒã‚’èª­ã¿è¾¼ã¿
image = Image.open("document.jpg").convert("RGB")

# å‰å‡¦ç†
batch_images = processor(images=[image]).to(model.device)

# 128æ¬¡å…ƒåŸ‹ã‚è¾¼ã¿ã‚’å–å¾—
with torch.no_grad():
    outputs = model(**batch_images)
    embeddings_128 = outputs.embeddings  # (1, 1030, 128)

# 2048æ¬¡å…ƒåŸ‹ã‚è¾¼ã¿ã‚’å–å¾—
with torch.no_grad():
    outputs = model.vlm(**batch_images, output_hidden_states=True)
    embeddings_2048 = outputs.hidden_states[-1]  # (1, 1030, 2048)

    # ãƒã‚¹ã‚­ãƒ³ã‚°é©ç”¨
    attention_mask = batch_images["attention_mask"].unsqueeze(-1)
    embeddings_2048 = embeddings_2048 * attention_mask

# Mean Pooling
pooled = embeddings_2048.mean(dim=1)  # (1, 2048)

# NumPyé…åˆ—ã«å¤‰æ›ï¼ˆLightGBM/SVRç”¨ï¼‰
numpy_vector = pooled.cpu().float().numpy()  # (1, 2048)
```

---

## ğŸ“ˆ æ¨å¥¨è¨­å®š

### OCR å“è³ªäºˆæ¸¬ã«æœ€é©ãªè¨­å®š

```bash
python main.py \
  --image /path/to/document.jpg \
  --embedding-type 2048dim \
  --pooling mean \
  --device auto
```

**ç†ç”±**:

- **2,048 æ¬¡å…ƒ**: ç”»è³ªåŠ£åŒ–æƒ…å ±ã‚’ä¿æŒ
- **Mean Pooling**: å…¨ä½“çš„ãªå“è³ªå‚¾å‘ã‚’æ‰ãˆã‚‹
- **å‡ºåŠ›**: `(1, 2048)` ã®å›ºå®šé•·ãƒ™ã‚¯ãƒˆãƒ« â†’ LightGBM/SVR ã¸ç›´æ¥å…¥åŠ›å¯èƒ½

---

## ğŸ“ ä»Šå¾Œã®æ‹¡å¼µ

### Phase 1: ãƒ™ã‚¯ãƒˆãƒ«å–å¾— âœ…ï¼ˆå®Œäº†ï¼‰

- ColPali ã‹ã‚‰ 128 æ¬¡å…ƒ / 2,048 æ¬¡å…ƒã‚’å–å¾—
- Pooling å®Ÿè£…

### Phase 2: å“è³ªäºˆæ¸¬å™¨æ§‹ç¯‰ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

1. ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæº–å‚™
2. OCR ã‚¨ãƒ³ã‚¸ãƒ³ã§æ­£è§£ãƒ©ãƒ™ãƒ«ä½œæˆï¼ˆCER/WERï¼‰
3. ColPali ã§ãƒ™ã‚¯ãƒˆãƒ«æŠ½å‡º
4. LightGBM/SVR ã§å­¦ç¿’
5. å“è³ªäºˆæ¸¬ãƒ¢ãƒ‡ãƒ«å®Œæˆ

### Phase 3: å¯è¦–åŒ–ãƒ»è§£é‡ˆæ€§

- Similarity Maps ç”Ÿæˆ
- ã©ã“ãŒå“è³ªã‚’ä¸‹ã’ã¦ã„ã‚‹ã‹å¯è¦–åŒ–

---

## ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯

- [ColPali è«–æ–‡](https://arxiv.org/abs/2407.01449)
- [vidore/colpali-v1.3-hf (HuggingFace)](https://huggingface.co/vidore/colpali-v1.3-hf)
- [PaliGemma (Google)](https://huggingface.co/google/paligemma-3b-mix-448)
- [ColPali Cookbooks](https://github.com/tonywu71/colpali-cookbooks)

---

## ğŸ“‹ å¤‰æ›´å±¥æ­´

### v2.0 (2026/01/04)

- **é‡å¤§ãªå¤‰æ›´**: `transformers` ã®ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£… (`ColPaliForRetrieval`) ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
- ãƒ¢ãƒ‡ãƒ«ã‚’ `vidore/colpali-v1.2` ã‹ã‚‰ `vidore/colpali-v1.3-hf` ã«æ›´æ–°
- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã® HF_TOKEN è‡ªå‹•èª­ã¿è¾¼ã¿æ©Ÿèƒ½ã‚’è¿½åŠ 
- BFloat16 â†’ float32 å¤‰æ›ã®å•é¡Œã‚’ä¿®æ­£

### v1.0 (2026/01/03)

- åˆç‰ˆãƒªãƒªãƒ¼ã‚¹
- ã‚«ã‚¹ã‚¿ãƒ  ColPali ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…

---

**ä½œæˆæ—¥**: 2026/01/03  
**æœ€çµ‚æ›´æ–°**: 2026/01/04  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0
